<?php

/**
 * Code alert queue
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7691 2011-02-04 15:43:29Z jwage $
 */
class CodeAlertQueue extends BaseCodeAlertQueue
{

    public static function saveCodeAlertQueue($shopId, $offerId)
    {
        $getRecord = Doctrine_Query::create()
            ->select()
            ->from("CodeAlertQueue")
            ->where('offerId = '.$offerId)
            ->fetchArray();

        if (empty($getRecord)) {
            $codeAlertQueue = new CodeAlertQueue();
            $codeAlertQueue->offerId = $offerId;
            $codeAlertQueue->shopId = $shopId;
            $codeAlertQueue->save();
        }
        return true;
    }

    public static function getRecepientsCount()
    {
        $codeAlertShopIds = Doctrine_Query::create()
        ->select('c.shopId')
        ->from('CodeAlertQueue c')
        ->fetchArray();

        $visitorsCount = 0;
        foreach ($codeAlertShopIds as $codeAlertShopId) {
            $count = Doctrine_Query::create()
                ->select('count(fs.id)')
                ->from('FavoriteShop fs')
                ->where('shopId = '.$codeAlertShopId['shopId'])
                ->fetchArray();

            foreach ($count as $countValue) {
                $visitorsCount += $countValue['count'];
                
            }
        }
        return $visitorsCount;
    }

    public static function getCodealertOffers()
    {
        $codeAlertOfferIds = Doctrine_Query::create()
        ->select('c.offerId,c.shopId')
        ->from('CodeAlertQueue c')
        ->fetchArray();
        $offers =  array();
        $visitorsCount = 0;
        foreach ($codeAlertOfferIds as $codeAlertOfferId) {
            $shop = FavoriteShop::getShopsById($codeAlertOfferId['shopId']);
           //  echo "<pre>"; print_r($shop);
            if(!empty($shop)) {
               // $offers[] = Offer::getOfferDetail($codeAlertOfferId['offerId']);
               
               foreach (Offer::getOfferDetail($codeAlertOfferId['offerId']) as $key => $value) {
                $offers = $value;
                $offers['shop']['visitors'] = $shop;
                $ooo[] = $offers;
               }
            }
            
            
        } 

 
        return $ooo;
    }
}
