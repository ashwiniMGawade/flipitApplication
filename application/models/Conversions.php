<?php

/**
 * Conversions
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7691 2011-02-04 15:43:29Z jwage $
 */
class Conversions extends BaseConversions
{
	
	/**
	 * getConversionId 
	 * 
	 * returns the conversion id and subid  based on shopId|offerId and  user ip
	 * 
	 * @param integer $id shop id
	 * @param long $ip ip address of user ip address (converted by ip2long fucntion)
	 * @param string $type conversion type offer or shop
	 * @return array
	 * @author Surinderpal Singh
	 */
	public static function getConversionId($id , $ip, $type ='offer')
	{
			
		$query =   Doctrine_Query::create()
				->select("id, subId")
				->from("Conversions")
				->where("ip = ?" , $ip);
		
		# get conversion based on type 
		if($type == 'offer')
		{
			$query->andWhere("offerId= ? " , $id);
		} else{
			$query->andWhere("shopId= ? " , $id);
		}
		
		return $query->fetchOne(null, Doctrine::HYDRATE_ARRAY) ;
	}

	
	/**
	 * updateConverted
	 * 
	 * set converted flag true if a conversion is converted
	 * 
	 * @param string $subid subId 
	 * @author Surinderpal Singh
	 */
	public static function updateConverted($subId)
	{
		$c = Doctrine_Query::create()
				->update('Conversions')
				->set('converted', 1 )
				->where('subid = ?' , $subId )->execute();
	}
	
	/**
	 * getConversionCookies
	 *
	 * function returns conversion cookie values based on subid 
	 * 
	 * @param string $subId subid
	 * @return array
	 * @author Surinderpal Singh
	 */
	public static function getConversionDetail($subId)
	{
		return  Doctrine_Query::create()->select('c.subid,c.utma,c.utmz,o.id,s.id,n.*')
				->from("Conversions c")
				->leftJoin("c.offer o")
				->leftJoin("o.shop s")
				->leftJoin("s.affliatenetwork n")
				->where('subid = ?' , $subId )
				->fetchOne(null, Doctrine::HYDRATE_ARRAY);
	}
	
	 
}