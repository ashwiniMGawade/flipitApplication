<?php
$this->minifyHeadScript()->prependFile("public/js/front_end/storeDetail.js");
$this->minifyHeadScript()->prependFile("public/js/front_end/socialmedia.js");
$this->minifyHeadLink()->prependStylesheet("/public/css/flipit-expired.css");

$currentDate = date('Y-m-d h:i:s ');
$offer = (object) $this->couponDetails[0];
$shopDiscussion = '';
$partialViewPath = 'partials/';
if($offer->shop['discussions'] == 1):
    $shopDiscussion = $this->partial($partialViewPath.'_discussion.phtml', array('shopName' => $offer->shop['name']));
endif;

$offerPartial = new FrontEnd_Helper_OffersPartialFunctions();
$message = $offerPartial->getExpiredOfferMessage($offer->endDate, $currentDate);

$extenderOffer = $this->partial(
    'store/_offer.phtml',
    array(
    'offers' => array($message=='' ? $this->couponDetails[0] : $this->topOfferFromStore[0]),
    'offersType'=>'expiredOffer',
    'shopName' =>'',
    'shop' =>'',
    'zendForm'=>$this->form
    )
);
$storeViewPartialPath = 'store/';
$howToUseGuidePermalink= "how-to/".$this->currentStoreInformation[0]['permaLink'];
$actualUrlWithoutDoubleSlash = explode("//", $this->currentStoreInformation[0]['actualUrl']);
if (isset($actualUrlWithoutDoubleSlash[1])):
    $actualUrl = $actualUrlWithoutDoubleSlash[1];
else:
    $actualUrl = $this->currentStoreInformation[0]['actualUrl'];
endif;

$shopEditor = '';
if($this->shopEditor != null):
    $shopEditor = $this->partial(
        $storeViewPartialPath.'_storeEditor.phtml',
        array(
           'shopEditor' => $this->shopEditor,
           'shop' => $this->currentStoreInformation[0],
           'howToUsePermalink'=>$howToUseGuidePermalink,
           'actualUrl'=>$actualUrl
        )
    );
endif;

$signUpWidgetForm = '';
if ($this->currentStoreInformation[0]['showSignupOption']) :
    $signUpWidgetForm = $this->partial(
        $storeViewPartialPath.'signupwidget.phtml',
        array(
           'zendForm' => $this->sidebarWidgetForm,
           'SignupFormWidgetType'=> 'sidebarWidget',
           'shopId'=>$this->currentStoreInformation[0]['id'],
           'shopLogoOrDefaultImage'=>''
        )
    );
endif;

$termsAndConditions = $offerPartial->getOfferTermsAndCondition($offer);
$termAndCondition = $this->partial(
    'offer/_howToUseAndAboutOffer.phtml',
    array(
        'termAndCondition' => $termsAndConditions,
        'offerDescription'=> $offer->extendedFullDescription,
        'expiredOffer'=> $this->couponDetails[0],
        'expiredMessage'=> $message == '' ? 'true':'false'
   )
);
echo $headerBlock = FrontEnd_Helper_viewHelper::getShopHeader($offer->shop, $message, $offer->title);
?>
<div class="row">
    <div id="content" class="col-md-8 col-sm-8">
    <?php 
    echo $message;
    echo $extenderOffer;
if ($message != '') { ?>
         </section>
    <?php
}
    echo $termAndCondition;
if ($message == '') {
    ?>
         </section>
    <?php 
}
        echo $shopDiscussion;
    
    ?>
    </div>
    <aside class="col-md-4 col-sm-4" id="sidebar">
    <?php
    echo $this->partial(
        'store/_shop-sidebar.phtml',
        array(
            'shopEditor' => $shopEditor,
            'latestShopUpdates'=> $this->latestShopUpdates,
            'shopChain' => $this->shopChain,
            'shop' => $this->currentStoreInformation[0],
            'popularStoresList'=> $this->popularStoresList,
            'signUpWidgetForm' => $signUpWidgetForm
        )
    );
    ?>
    </aside>
</div>