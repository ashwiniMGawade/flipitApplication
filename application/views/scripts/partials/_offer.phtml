<?php $this->partial('offer/_jsFileForOfferPartial.phtml'); ?>
<script type="text/javascript">
    var domainName = "<?php echo HTTP_PATH; ?>";
</script>
<?php
$class = "section";
if (zend_Controller_Front::getInstance()->getRequest()->getControllerName()=='Favourite' 
    && zend_Controller_Front::getInstance()->getRequest()->getActionName()=='sharesocialcode') {
    $class = "";
}
?>
<section class="<?php echo $class; ?>">
<?php
$offerCounter = '';
$visitorInformation = '';

foreach ($this->offers as $offer) {
    $offerCounter++;
    $offer = (object) $offer;
    $offerBounceRate = "/out/offer/".$offer->id;
    $offerPartial = new FrontEnd_Helper_OffersPartialFunctions();
    $daysTillOfferExpires = $offerPartial->getDaysTillOfferExpires($offer->endDate);
    $urlToShow = $offerPartial->getUrlToShow($offer);
    $offerTitle = FrontEnd_Helper_viewHelper::replaceStringVariable($offer->title);
    $termsAndConditions = $offerPartial->getOfferTermsAndCondition($offer);
    $userLoggedInOrNot = $offerPartial->getUserIsLoggedInOrNot();
    $couponCode = $offer->couponCode;
    if (isset($offer->couponCodeType) && $offer->couponCodeType == 'UN') {
         $couponCode = '';
    }

    $defaultText = '';
    $offerHolderClass = "offer-holder";
    if ($offer->exclusiveCode == '1') {
        $offerClass = "orange-block";
    } else if ($offer->userGenerated == '1') {
        $offerClass = "";
        $offerHolderClass = "";
        $urlToShow = 'javascript:void(0);';
        if ($offer->approved == '1') {
            $offerClass = "social-block"; 
            $offerHolderClass = "offer-holder";
            $urlToShow = $offerPartial->getUrlToShow($offer);
        }
        $site = LOCALE == '' ? "Kortingscode" : "Flipit";
        $defaultText = FrontEnd_Helper_viewHelper::__translate('This code is not verified by').' '.$site.' ';
    } else {
        $offerClass = "active";
    }

    $esiLocale = LOCALE != 'en' ? LOCALE . '/' : '';

    ?>
    <article class="block <?php echo $offerClass; ?>">
        <div class="holder <?php echo $offerHolderClass; ?>" id="<?php echo $offer->id; ?>">
    <?php 
    echo $offerPartial->getCommonRedirectUrlForOffer(
        $offer,
        $urlToShow,
        $offerBounceRate,
        $this->offersType,
        'offerImage'
    );
    ?>
            <div class="box">
                <div class="text">
                    <p> <?php
                        $membersOnly = isset($offer->Visability) && $offer->Visability == 'MEM'
                            ? '<span class="members-only-image"></span><span class="members-only">'.$this->translate("Members Only").'</span>'
                            : '';
                        echo $membersOnly.$offerPartial->getOfferOptionAndOfferDates($offer, $daysTillOfferExpires);
                        ?>
                    </p>
                    <?php 
                    if ($offer->Visability == 'MEM') {
                        echo $this->esi($esiLocale.'signup/signupmembersonlytitle?shopId='.$offer->shop['id']
                            .'&signupFormWidgetType=widgetWithinOffers&offerId='.$offer->id.'&shopLogoOrDefaultImage=');
                    } else {
                        echo $offerPartial->getCommonRedirectUrlForOffer(
                            $offer,
                            $urlToShow,
                            $offerBounceRate,
                            $offerTitle,
                            'offerTitle'
                        ); 
                    }
                    ?>
                </div>
                <div class="buttons" id="offerButton<?php echo $offer->id ;?>">
    <?php

    $permalink = $this->offersType=='categoryOffers' ? $this->categoryPermaLink : $offer->shop['permalink'];

    if ($offer->Visability == 'MEM') {
        echo $this->esi($esiLocale.'signup/signupwidgetcodes?shopId='.$offer->shop['id']
            .'&signupFormWidgetType=widgetWithinOffers&offerId='.$offer->id.'&shopLogoOrDefaultImage=');
    } else {
        echo $offerPartial->getCommonRedirectUrlForOffer(
            $offer,
            $urlToShow,
            $offerBounceRate,
            $permalink,
            'mainOfferClickoutButton'
        );
        echo $offerPartial->getSecondButtonforOffer($offer, $urlToShow, $offerBounceRate, $permalink); 
    }

    ?>
                </div>
                <div class="the-code" id="offerCodeDiv<?php echo $offer->id ;?>">
                    <span class="instruction">
                        <strong><?php echo $this->translate('enter this code at checkout')?></strong>
                    </span>
                    <strong class="code-value"><?php echo $couponCode;?></strong>
                </div>
                <ul class="view-list">
    <?php 
    if (isset($offer->extendedOffer) && $offer->extendedOffer =='1') {
        $extendedOffer = 1;
    } else {
        $extendedOffer = 0;
    }
    $showHyphen = $termsAndConditions != '' || $extendedOffer == 1 ? '<li> -</li>' : '';
    if ($this->offersType!='extendedOffer') {
        if ($termsAndConditions != '') {
            echo $offerPartial->getTermAndConditionsLink($offer, $termsAndConditions);
        }
        echo $offerPartial->getExtendedOfferLink($offer);
        if($this->offersType!='simple'):
            echo $offerPartial->getViewAllCodeLink(
                $offer->shopOffers['name'],
                $offer->shopOffers['permaLink'],
                $showHyphen
            );
        endif;
    } else {
        echo $offerPartial->getViewAllCodeLink($offer->shopOffers['name'], $offer->shopOffers['permaLink'], '');
    }
    if ($offer->userGenerated == 1 && ($offer->approved == '1' || $offer->approved == '0')) : ?>
        <li id="fr">
            <?php echo $this->translate('Code shared by').' '.$offer->nickname;?>
        </li>
        <?php endif;
    ?>
                </ul>
            </div>
            <?php 
            if ($offer->userGenerated == 0) {
                //echo $offerPartial->getVerifiedText();
            }
            ?>
        </div>
    <?php
    if ($this->offersType!='extendedOffer') {
            $style = '';
    } else {
            $style = 'style="display:block;"';
    }
    if ($offer->editorPicks == 1) {
    ?>
        <hr class="alt2">
        <div class="recommended-outerDiv">
            <div class="recommended-arrow"></div>
            <div class="recommendedOffer">
                <span>
                    <img src="<?php echo HTTP_PATH.'public/images/rec-thumb.png';?>" class="recommended-thumb" alt="thumb" title="thumb">
                    <?php echo $this->translate('Recommended by staff');?>
                </span>
                <?php
                $authorName = !empty($offer->authorName) ? $offer->authorName : ''; 
                echo ' - '.$authorName.' '.$this->translate('Recommended this code');?>
            </div>
        </div>
    <?php } ?>    
        <div class="offer-box" id="websiteOfferLink<?php echo $offer->id ;?>" <?php echo $style;?>>
            <hr class="alt2">
            <div class="offer">
                <span><?php echo $this->translate('Grab this offer now:');?></span>
                <a target = "_blank" href="<?php echo $urlToShow;?>" rel= "nofollow">
                <?php echo $this->translate('Open ');?>
                <?php echo $offer->shopOffers['name']; ?>
                <?php echo $this->translate(' website');?>
                </a>
            </div>
        </div>
        <?php if ($termsAndConditions != '') : ?>
        <div  class="terms-block" id='termAndConditions<?php echo $offer->id ;?>'>
            <h2><?php echo $this->translate('Terms &amp; Conditions'). " (". $defaultText.")";?></h2>
            <ol class="num-list">
            <?php echo $termsAndConditions;?>
            </ol>
        </div>
        <?php endif; ?>
       
    </article>
    <?php
    $shopLogoOrDefaultImage = $offerPartial->getShopLogoForSignUp($this->shopOffers);
    if($offerCounter == 1) :
        if($this->offersType=='simple' || $this->offersType=='top20' || $this->offersType=='offerPage'
            || $this->offersType=='offerWithPagenation' || $this->offersType=='newestOffer'):
            $this->locale = LOCALE != 'en' ? LOCALE . '/' : '';
            echo $this->esi($this->locale.'signup/signupwidgetlarge?shopId='.$this->currentStoreInformation[0]['id']
                .'&signupFormWidgetType=widgetWithinOffers&shopLogoOrDefaultImage=');
        endif;
    endif;
}
if ($this->offersType!='extendedOffer') {
    if ($this->offersType == 'newestOffer'
        || $this->offersType=='offerWithPagenation'
        || $this->offersType=='offerPage') {
        echo $this->paginationControl($this->offers, 'Sliding', '/partials/_pagination.phtml');
    }
    if (isset($this->pageType) && $this->pageType == 'howToGuide') {
        $domainName = LOCALE == '' ? HTTP_PATH : HTTP_PATH_LOCALE;
        echo '<a class="link-box" href="'.$domainName.$offer->shopOffers['permaLink'].'">
                <hr class="alt2">
                '.$this->translate('View all voucher codes from').' '.$offer->shopOffers['name'].'
            </a>';
    }
    ?>
    </section>
    <?php 
}